angular.module("templates",[]).run(["$templateCache",function(e){e.put("map/map.tpl.html",'<gbif-map key="{{searchController.usageKey}}" show-slider="{{mainController.showSlider}}"></gbif-map>'),e.put("search/search.tpl.html",'<div>\n  <div class="row" id="search">\n    <div class="col-md-12">\n      <alert ng-repeat="alert in searchController.alerts" type="{{alert.type}}" close="searchController.closeAlert($index)">{{alert.content}}</alert>\n      <div class="row">\n        <div class="col-md-8">\n          <table ng-if="searchController.result" class="table table-condensed">\n            <thead>\n            <th>Key</th>\n            <th>Canonical Name</th>\n            <th>Scientific Name</th>\n            <th>Rank</th>\n            </thead>\n            <tbody>\n            <tr ng-click="searchController.setUsageKey(searchController.result.usageKey)">\n              <td>{{searchController.result.usageKey}}</td>\n              <td>{{searchController.result.canonicalName}}</td>\n              <td>{{searchController.result.scientificName}}</td>\n              <td>{{searchController.result.rank}}</td>\n              <td>{{searchController.result.records}}</td>\n            </tr>\n            </tbody>\n          </table>\n        </div>\n        <div class="col-md-4">\n          <form name="form" no-validate ng-submit="searchController.find(searchController.search)">\n            <div class="form-group">\n              <input name="search" type="text" class="form-control"\n                     placeholder="Ex: Animalia, Pica pica, Puma Concolor"\n                     ng-model="searchController.search"\n                     ng-change="searchController.suggest(searchController.search)"\n                     typeahead="suggestion.canonicalName for suggestion in searchController.suggestions"/>\n            </div>\n            <div class="pull-right">\n              <button type="submit" class="btn btn-default"\n                      ng-disabled="!searchController.search">Search\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="row">\n    <div class="col-md-10">\n      <button type="button" class="btn btn-primary" ng-model="mainController.showSlider" btn-checkbox btn-checkbox-true="true" btn-checkbox-false="false">\n        Show slider\n      </button>\n      <div id="map" ng-include="\'map/map.tpl.html\'"></div>\n    </div>\n    <div class="col-md-2">\n      <div id="last-search-requests" class="hidden-sm hidden-xs">\n        <h3>Last search requests</h3>\n        <ul ng-if="(searchController.lastSearches.length > 0)">\n          <li ng-repeat="lastSearch in searchController.lastSearches | limitTo:10">\n            <a ui-sref="search({search:lastSearch})">{{ lastSearch }}</a>\n          </li>\n        </ul>\n        <div ng-if="!(searchController.lastSearches.length > 0)"><span>No previous requests.</span></div>\n        <ul>\n        </ul>\n      </div>\n    </div>\n  </div>\n</div>')}]),function(){angular.module("gbif-tool",["ui.bootstrap","ui.router","templates","gbif-search","gbif-map"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/search/"),e.state("search",{url:"/search/:search",templateUrl:"search/search.tpl.html",controller:"SearchController",controllerAs:"searchController"})}]).config(["$httpProvider",function(e){e.interceptors.push("AppHttpInterceptor")}])}(),function(){function e(){var e=this;e.showSlider=!1}angular.module("gbif-tool").controller("MainController",e)}(),function(){function e(e){return{request:function(t){return e.spinner=!0,t},response:function(t){return e.spinner=!1,t},responseError:function(t){return e.spinner=!1,t}}}angular.module("gbif-tool").factory("AppHttpInterceptor",["$rootScope",e])}(),function(){angular.module("gbif-map",["ui.slider"])}(),function(){function e(){var e=function(e){var t="";return"PRE_1900"===e||"NO_YEAR"===e?(t+="&layer=OBS_"+e,t+="&layer=SP_"+e,t+="&layer=OTH_"+e):(t+="&layer=OBS_"+e+"_"+(e+10),t+="&layer=SP_"+e+"_"+(e+10),t+="&layer=OTH_"+e+"_"+(e+10))},t=function(t){var r="";if(t.withoutYear)return e("NO_YEAR");var a=parseInt(t.minDate,10),n=parseInt(t.maxDate,10);if(a===n)r+=e(1890===a?"PRE_1900":a);else{var o=a;for(o;n>o;o+=10)r+=e(1890===o?"PRE_1900":o)}return r};return{setBackground:function(e){var t="http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png";L.tileLayer(t,{subdomains:["otile1","otile2","otile3","otile4"]}).addTo(e)},updateTileLayer:function(e,r,a,n){var o="http://api.gbif.org/v1/map/density/tile?x={x}&y={y}&z={z}&type=TAXON&palette=yellows_reds";if(!_.isEmpty(n)){var l=t(n);o+=l}return _.isEmpty(r)||e.removeLayer(r),""!==a&&(r=L.tileLayer(o+"&key="+a,{maxZoom:18}),r.addTo(e)),r}}}angular.module("gbif-map").factory("MapService",e)}(),function(){function e(e,t){return{restrict:"E",template:'<div><div id="gbif-map" class="map"></div></div>',replace:!0,scope:!0,link:function(r,a,n){var o=L.map("gbif-map",{center:[20,0],zoom:2,minZoom:2});e.setBackground(o);var l,s=n.key;n.$observe("key",function(t){l=e.updateTileLayer(o,l,t,null),s=t}),r.$on("$destroy",function(){o.remove(),l=null}),n.$observe("showSlider",function(n){"true"===n?(r.dateRange={withoutYear:!1,minDate:1890,maxDate:2020},a.append('<div id="slider"><slider floor="1890" ceiling="2020" step="10"   ng-model-low="dateRange.minDate" ng-model-high="dateRange.maxDate"></slider>  <div>    <p>From {{ dateRange.minDate == \'1890\' ? \'Before 1900\' : dateRange.minDate }} to             {{ dateRange.maxDate == \'1890\' ? \'Before 1900\' : dateRange.maxDate }}</p>    <div class="form-group">       <label>Show only occurrences without years:</label>       <input type="checkbox" ng-model="dateRange.withoutYear">    </div>  </div></div>'),r.$watch("dateRange",function(){l=e.updateTileLayer(o,l,s,r.dateRange)},!0),t(a)(r)):(angular.element(a.children()[1]).remove(),l=e.updateTileLayer(o,l,s,null))})}}}angular.module("gbif-map").directive("gbifMap",["MapService","$compile",e])}(),function(){angular.module("gbif-search",[])}(),function(){function e(e,t){function r(r){e.find(r).then(function(a){"NONE"!==a.data.matchType?(l.result=a.data,l.usageKey=l.result.usageKey,e.storeLastSearch(r),t.go("search",{search:r})):l.alerts.push({type:"info",content:"No results are matching your request"})},function(e){l.alerts.push({type:"danger",content:e})})}function a(t){e.suggest(t).then(function(e){l.suggestions=e.data},function(e){l.alerts.push({type:"warning",content:e})})}function n(e){l.alerts.splice(e,1)}function o(){return e.retrieveLastSearches()}var l=this;l.search=t.params.search?t.params.search:void 0,l.usageKey=void 0,l.result=void 0,l.alerts=[],l.find=r,l.suggest=a,l.closeAlert=n,l.lastSearches=o(),l.search&&l.find(l.search)}angular.module("gbif-search").controller("SearchController",["SearchService","$state",e])}(),function(){function e(e){var t="http://api.gbif.org/v1/species/match?verbose=true&name=",r="http://api.gbif.org/v1/species/suggest?q=";return{find:function(r){return e.get(t+r,{cache:!0})},suggest:function(t){return e.get(r+t)},storeLastSearch:function(e){var t=JSON.parse(localStorage.getItem("lastSearches"));_.isEmpty(t)?localStorage.setItem("lastSearches",JSON.stringify([e])):(t.push(e),localStorage.setItem("lastSearches",JSON.stringify(t)))},retrieveLastSearches:function(){var e=JSON.parse(localStorage.getItem("lastSearches"));return _.isEmpty(e)?void 0:_.uniq(JSON.parse(localStorage.getItem("lastSearches")).reverse())}}}angular.module("gbif-search").factory("SearchService",["$http",e])}();